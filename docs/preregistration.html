<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.549">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>QUBPsyOpenScience</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./images/favicon.ico" rel="icon">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script async="" src="https://www.googletagmanager.com/gtag/js?id=G-4HGH1K5VWH"></script>

<script type="text/javascript">

window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-4HGH1K5VWH', { 'anonymize_ip': true});
</script>


<meta property="og:title" content="QUBPsyOpenScience">
<meta property="og:description" content="">
<meta property="og:site_name" content="QUBPsyOpenScience">
<meta name="twitter:title" content="QUBPsyOpenScience">
<meta name="twitter:description" content="">
<meta name="twitter:creator" content="@QUBPsych">
<meta name="twitter:card" content="summary">
</head>

<body class="nav-fixed fullcontent">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a href="./index.html" class="navbar-brand navbar-brand-logo">
    <img src="./images/QUBlogoWsmall.png" alt="" class="navbar-logo">
    </a>
    <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">QUBPsyOpenScience</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="./index.html"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./intro.html"> 
<span class="menu-text">Principles</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link active" href="./preregistration.html" aria-current="page"> 
<span class="menu-text">Preregistration</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./ethics.html"> 
<span class="menu-text">Ethics and Open Science</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./open_data.html"> 
<span class="menu-text">Open Data</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./open_materials.html"> 
<span class="menu-text">Open Materials</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./open_source_formats.html"> 
<span class="menu-text">Open-Source formats</span></a>
  </li>  
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-reproducibility" role="button" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Reproducibility</span>
    </a>
    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="nav-menu-reproducibility">    
        <li>
    <a class="dropdown-item" href="./reproducible_documents.html">
 <span class="dropdown-text">Reproducible Documents</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./github.html">
 <span class="dropdown-text">Git and GitHub</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./Tutorial_1-Git,Github,andRStudio.html">
 <span class="dropdown-text">Tutorial 1: Git, Github, and RStudio</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item">
    <a class="nav-link" href="./open-access_publishing.html"> 
<span class="menu-text">Open-Access Publishing</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./education.html"> 
<span class="menu-text">Education</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./license.html"> 
<span class="menu-text">License</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
          <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    
<!-- main -->
<main class="content" id="quarto-document-content">




<section id="Preregistration" class="level1">
<h1>Preregistration</h1>
<p><strong>We encourage staff to preregister their research as standard.</strong>&nbsp;</p>
<section id="what-is-preregistration" class="level2">
<h2 class="anchored" data-anchor-id="what-is-preregistration">What is preregistration?&nbsp;</h2>
<p><a href="https://www.pnas.org/doi/10.1073/pnas.1708274114">Preregistration</a> involves publishing your plans in a protocol for research before you conduct the research. This preregistration should be version-controlled, time-stamped, and deposited in a publicly accessible repository. It ensures that any change to the research plans or protocol can be traced, which disincentivizes presenting a changed protocol as the original, intended protocol. The more detailed the preregistered protocol, the more preregistration prevents results being influenced – even inadvertently – by undisclosed flexibility in research practices, which is known to affect replicability. Most pre-registered information should include the following:&nbsp;</p>
<ol type="1">
<li>A statement of the hypotheses/research questions being assessed&nbsp;</li>
</ol>
<!-- -->
<ol start="2" type="1">
<li>A clear methodology which can be replicated by other researchers&nbsp;</li>
</ol>
<!-- -->
<ol start="3" type="1">
<li>The key variables that will be measured and/or theoretical lens by which information will be viewed&nbsp;</li>
</ol>
<!-- -->
<ol start="4" type="1">
<li>An indication of the intended sample size (ideally justified with a power analysis for quantitative research) and how this will be obtained (recruitment/retention plans)&nbsp;</li>
</ol>
<!-- -->
<ol start="5" type="1">
<li>A detailed description of the analysis that will be conducted&nbsp;</li>
</ol>
<!-- -->
</section>
<section id="what-are-the-benefits-of-preregistration" class="level2">
<h2 class="anchored" data-anchor-id="what-are-the-benefits-of-preregistration">What are the benefits of preregistration?&nbsp;</h2>
<ul>
<li><p>More robust and transparent research: increased trustworthiness and confidence in replicability&nbsp;&nbsp;</p></li>
<li><p>Clarity on dissociation between confirmatory and exploratory analyses&nbsp;&nbsp;&nbsp;</p></li>
<li><p>Clarity on plan for research team – a document to guide data analyses&nbsp;&nbsp;</p></li>
</ul>
<!-- -->
<ul>
<li><p>Avoiding any suggestion of benefiting from undisclosed flexibility&nbsp;&nbsp;</p></li>
<li><p>Available as article type (Registered Reports), ensuring publication of confirmatory science irrespective of results&nbsp;&nbsp;</p></li>
<li><p>Researchers are being criticized for P-hacking (reporting only significant findings) and <a href="https://journals.sagepub.com/doi/10.1207/s15327957pspr0203_4">HARKing</a> (hypothesising after the results are known) within scientific research; through preregistration we can illustrate that we do not engage in these practices&nbsp;</p></li>
</ul>
</section>
<section id="what-types-of-research-could-be-preregistered" class="level2">
<h2 class="anchored" data-anchor-id="what-types-of-research-could-be-preregistered">What types of research could be preregistered?&nbsp;</h2>
<p>All types of research can be pre-registered. Preregistration can be used for both confirmatory and exploratory research, in any research approach – quantitative and qualitative. Besides quantitative experimental designs, this includes among others observational designs, survey designs, randomized trials, secondary data analyses, qualitative interviews, ethnographies or focus groups, and systematic reviews. The key here is that the preregistration provides transparency about what the research plan was prior to data collection. For some designs such as ethnography or qualitative interviews, minimal information may be known in advance; for others such as randomised trials, much more information will be known and available for preregistration.&nbsp;</p>
</section>
<section id="how-do-i-preregister-my-plansprotocols-for-research" class="level2">
<h2 class="anchored" data-anchor-id="how-do-i-preregister-my-plansprotocols-for-research">How do I preregister my plans/protocols for research?&nbsp;</h2>
<p>How and where to register your protocols depends on the purpose and the type of research you are conducting. Several online repositories have been created that are optimized for the practice of preregistration and transparency (e.g., version control, links to data). These are given below.&nbsp;</p>
<p>There may be different requirements for each type of research and the <a href="https://www.equator-network.org/">Equator Network</a> have provided <a href="https://www.equator-network.org/?post_type=eq_guidelines&amp;eq_guidelines_study_design=study-protocols&amp;eq_guidelines_clinical_specialty=0&amp;eq_guidelines_report_section=0&amp;s=+">guidance</a> on what to include in protocols for a selection of different designs. To date, this includes trials, intervention detail, systematic reviews, tomography studies, intervention development studies, and core outcome sets. You can also publish the protocol as a peer-reviewed journal article, but this should be considered in addition to the registrations below given the time the peer-review process takes. If your chosen journal facilitates this (see <a href="https://v2.sherpa.ac.uk/romeo/">Sherpa Romeo</a> you could deposit the pre-print (i.e., the manuscript submitted for publication) at a pre-print server such as <a href="https://psyarxiv.com/">PsyArXiv</a>.&nbsp;</p>
</section>
<section id="main-pre-registration-repositories" class="level2">
<h2 class="anchored" data-anchor-id="main-pre-registration-repositories">Main pre-registration repositories&nbsp;</h2>
<p>Below, we list the main repositories to help staff get started with preregistration on these portals.&nbsp;</p>
<p><a href="https://aspredicted.org/"><strong>https://AsPredicted.org</strong></a>&nbsp;</p>
<ul>
<li><p>Mainly for quantitative research&nbsp;</p></li>
<li><p>Answer 10 questions about research protocol</p></li>
<li><p>Answers saved as pdf website&nbsp;</p></li>
<li><p>Example: <a href="https://aspredicted.org/p6956.pdf">Valkanidis, Doumas, and Dessing (2020)</a>&nbsp;</p></li>
<li><p>Researchers control the visibility (private or public).&nbsp;</p></li>
</ul>
<p><a href="https://osf.io/prereg/"><strong>Open Science Framework | OSF Preregistration</strong></a>&nbsp;</p>
<ul>
<li>Platform dedicated to Open Science.</li>
</ul>
<!-- -->
<ul>
<li><p>Variety of formats for specific types of research (e.g., quantitative, qualitative, systematic reviews, scoping reviews, secondary data analyses)&nbsp;</p></li>
<li><p>Can be helpful for student preregistrations (supervisors are encouraged to create a single page for a given academic year cohort e.g., 2022/2023, with folders for each registered project)&nbsp;</p></li>
<li><p>Examples: <a href="https://osf.io/sqh36">Reid and Dessing (2016)</a>, <a href="https://osf.io/xvhgg/">Schultze, Gerlach and Rittich ( 2017)</a></p></li>
</ul>
<p><a href="https://clinicaltrials.gov/"><strong>ClinicalTrials.gov</strong></a>&nbsp;</p>
<ul>
<li><p>Preregistration of clinical trials&nbsp;</p></li>
<li><p>It is an ethical requirement as per the <a href="http://www.wma.net/en/30publications/10policies/b3/">Declaration of Helsinki</a> that every clinical trial must be registered in a publicly accessible database before recruitment of the first participant. A list of other registration sites are: <a href="https://www.who.int/ictrp/network/primary/en/">Primary Registries in the WHO Registry Network</a> or an <a href="http://www.icmje.org/about-icmje/faqs/clinical-trials-registration/">ICMJE approved registry</a>. Please note that some of these may incur a charge. For trials you should also complete a <a href="https://www.equator-network.org/reporting-guidelines/spirit-2013-statement-defining-standard-protocol-items-for-clinical-trials/">SPIRIT protocol</a> document for your Trial Master file.&nbsp;</p></li>
</ul>
<p><a href="https://www.crd.york.ac.uk/prospero/"><strong>PROSPERO (york.ac.uk)</strong></a>&nbsp;</p>
<ul>
<li>Preregistration of systematic reviews&nbsp;</li>
</ul>
<!-- -->
<ul>
<li>If you are aiming to publish your systematic review, you may severely limit your publication chances if you do not preregister your review. Good guidance on systematic review conduct can be found on <a href="https://www.york.ac.uk/media/crd/Systematic_Reviews.pdf">York Centre for Reviews and Dissemination</a>. To minimize work for the team at PROSPERO, only those reviews you intend to publish should be hosted at this site. For reviews in the context of teaching the Open Science Framework is more appropriate, but the preregistration could follow the structure of the PROSPERO registration.&nbsp;&nbsp;</li>
</ul>
<p><a href="https://www.comet-initiative.org/"><strong>COMET Initiative</strong></a>&nbsp;</p>
<ul>
<li>For core outcome sets or minimum data standards&nbsp;</li>
</ul>
<p>Please consider depositing your preregistration on the PURE platform after you have registered it on one of the platforms above. To do so, log into your PURE account, go to research outputs, other contribution, protocol, and select either peer-reviewed (e.g., Prospero) or non-peer-reviewed (e.g., OSF) and link to the DOI. You might also want to highlight this as a protocol in the title of the deposit to minimise confusion if you use the same title for the paper arising from the work.&nbsp;</p>
</section>
<section id="registered-reports" class="level2">
<h2 class="anchored" data-anchor-id="registered-reports">Registered reports&nbsp;</h2>
<p>This is a form of preregistration, where a paper is accepted by journals at the protocol stage, prior to data collection. The protocol goes through the peer review process where the introduction, hypotheses, methods and analysis plan are scrutinized before data is collected. This is used for both quantitative and qualitative studies. If accepted, the journal commits to publishing the full report irrespective of the results, as long as the preregistered protocol is followed and the conclusions are justified by the data.&nbsp;</p>
<p>Once data is collected and analyzed the registered report is updated with the findings and write up and is resubmitted to the same journal for further peer review.&nbsp; You can read more about registered reports <a href="https://cos.io/rr/">here</a>. The site linked also contains a list of journals already offering the registered reports format. Note, however, that this approach may have implications which compete with time demands of external funders or student supervision.&nbsp;</p>
</section>
<section id="common-questions" class="level2">
<h2 class="anchored" data-anchor-id="common-questions">Common questions&nbsp;</h2>
<p><em>Doesn’t preregistration stifle exploration and creativity?</em>&nbsp;</p>
<p>No.&nbsp;Nothing prevents further exploration of the patterns within a dataset. Preregistration just ensures that such analyses are appropriately identified as exploratory. Plans can also change, and this can be reflected in an updated version of the preregistered protocol prior to research start, or if research has already started, then transparently reported and explained as a deviation from the protocol in the write up.&nbsp;</p>
<p><em>Is it extra work?</em>&nbsp;</p>
<p>Yes and no. Yes, preregistration typically involves an in-depth research protocol, the details of which may take more time to iron out. However, since most research within Psychology requires an ethics application, which also involves a research protocol, at least part of the information is already written down even without preregistration. Moreover, preregistration changes the order in which researchers spend time: putting in more effort before data collection reduces the time needed from data collection to dissemination.&nbsp;</p>
<p><em>If I preregister elsewhere why do I need to add it to my PURE repository?</em>&nbsp;</p>
<p>Any preregistration on any site/portal implies that you are doing the work; it creates an easily searchable protocol, which individuals who are considering similar work can see to avoid duplication of effort (e.g., in reviews), or to guide replication efforts (e.g., replication studies).&nbsp;</p>
<p>It is useful to deposit your published preregistration on PURE as it can link to the final publication when it has been published; this demonstrates your (and your co-authors’) commitment to open science, and institutional commitment to open science which grows our research reputation.&nbsp;</p>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>